name: å²é˜…é¡¹ç›® CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    runs-on: ubuntu-latest
    name: ä»£ç è´¨é‡æ£€æŸ¥
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: ç¯å¢ƒé…ç½®æ£€æŸ¥
      run: |
        echo "æ£€æŸ¥ç¯å¢ƒé…ç½®æ–‡ä»¶..."
        if [ ! -f ".env.local.template" ]; then
          echo "âŒ .env.local.template æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        echo "âœ… ç¯å¢ƒé…ç½®æ–‡ä»¶æ£€æŸ¥é€šè¿‡"
      
    - name: æ•æ„Ÿä¿¡æ¯æ£€æŸ¥
      run: |
        echo "æ£€æŸ¥æ•æ„Ÿä¿¡æ¯æ³„éœ²..."
        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨çœŸå®çš„APIå¯†é’¥æ¨¡å¼
        if grep -r "sk-[a-f0-9]\{32\}" --exclude-dir=node_modules --exclude-dir=.git . || \
           grep -r "LTAI[a-zA-Z0-9]\{16,\}" --exclude-dir=node_modules --exclude-dir=.git . ; then
          echo "âŒ å‘ç°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯æ³„éœ²"
          exit 1
        fi
        echo "âœ… æ•æ„Ÿä¿¡æ¯æ£€æŸ¥é€šè¿‡"
        
    - name: TypeScript ç±»å‹æ£€æŸ¥
      run: npm run type-check
      
    - name: ESLint æ£€æŸ¥
      run: npm run lint
      continue-on-error: true
      
    - name: æ„å»ºæµ‹è¯•
      env:
        NEXT_PUBLIC_CLOUDBASE_ENV_ID: ${{ secrets.CLOUDBASE_ENV_ID }}
        NEXT_TELEMETRY_DISABLED: 1
      run: |
        echo "å¼€å§‹æ„å»ºæµ‹è¯•..."
        npm run build

  # ç¯å¢ƒå˜é‡éªŒè¯
  env-validation:
    runs-on: ubuntu-latest
    name: ç¯å¢ƒå˜é‡éªŒè¯
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: éªŒè¯ç”Ÿäº§ç¯å¢ƒå˜é‡
      env:
        NEXT_PUBLIC_CLOUDBASE_ENV_ID: ${{ secrets.CLOUDBASE_ENV_ID }}
        TONGYI_ACCESS_KEY_ID: ${{ secrets.TONGYI_ACCESS_KEY_ID }}
        DASHSCOPE_API_KEY: ${{ secrets.TONGYI_ACCESS_KEY_ID }}
        ALIBABA_ACCESS_KEY_ID: ${{ secrets.ALIBABA_ACCESS_KEY_ID }}
        ALIBABA_ACCESS_KEY_SECRET: ${{ secrets.ALIBABA_ACCESS_KEY_SECRET }}
      run: |
        echo "éªŒè¯å…³é”®ç¯å¢ƒå˜é‡..."
        
        # æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡
        if [ -z "$NEXT_PUBLIC_CLOUDBASE_ENV_ID" ]; then
          echo "âŒ NEXT_PUBLIC_CLOUDBASE_ENV_ID æœªè®¾ç½®"
          exit 1
        fi
        
        if [ -z "$TONGYI_ACCESS_KEY_ID" ]; then
          echo "âš ï¸  TONGYI_ACCESS_KEY_ID æœªè®¾ç½®ï¼ŒAIåŠŸèƒ½å°†ä½¿ç”¨æ¨¡æ‹Ÿå“åº”"
        fi
        
        if [ -z "$ALIBABA_ACCESS_KEY_ID" ]; then
          echo "âš ï¸  ALIBABA_ACCESS_KEY_ID æœªè®¾ç½®ï¼Œéƒ¨åˆ†åŠŸèƒ½å°†å—é™"
        fi
        
        echo "âœ… ç¯å¢ƒå˜é‡éªŒè¯å®Œæˆ"

  # éƒ¨ç½²åˆ° CloudBaseï¼ˆä»…ä¸»åˆ†æ”¯ï¼‰
  deploy:
    runs-on: ubuntu-latest
    name: éƒ¨ç½²åˆ° CloudBase
    needs: [code-quality, env-validation]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: æ„å»ºé¡¹ç›®
      env:
        NEXT_PUBLIC_CLOUDBASE_ENV_ID: ${{ secrets.CLOUDBASE_ENV_ID }}
        NEXT_TELEMETRY_DISABLED: 1
        NODE_ENV: production
      run: npm run build
      
    - name: å®‰è£… CloudBase CLI
      run: npm install -g @cloudbase/cli
      
    - name: CloudBase ç™»å½•
      env:
        CLOUDBASE_SECRET_ID: ${{ secrets.TENCENT_SECRET_ID }}
        CLOUDBASE_SECRET_KEY: ${{ secrets.TENCENT_SECRET_KEY }}
      run: |
        tcb login --key --secretId "$CLOUDBASE_SECRET_ID" --secretKey "$CLOUDBASE_SECRET_KEY"
        
    - name: è®¾ç½®å®¹å™¨ç¯å¢ƒå˜é‡
      env:
        TONGYI_ACCESS_KEY_ID: ${{ secrets.TONGYI_ACCESS_KEY_ID }}
        ALIBABA_ACCESS_KEY_ID: ${{ secrets.ALIBABA_ACCESS_KEY_ID }}
        ALIBABA_ACCESS_KEY_SECRET: ${{ secrets.ALIBABA_ACCESS_KEY_SECRET }}
        XFYUN_APP_ID: ${{ secrets.XFYUN_APP_ID }}
        XFYUN_API_SECRET: ${{ secrets.XFYUN_API_SECRET }}
        XFYUN_API_KEY: ${{ secrets.XFYUN_API_KEY }}
      run: |
        echo "è®¾ç½®å®¹å™¨ç¯å¢ƒå˜é‡..."
        
        # è®¾ç½®å¿…éœ€çš„ç¯å¢ƒå˜é‡
        if [ ! -z "$TONGYI_ACCESS_KEY_ID" ]; then
          echo "è®¾ç½® TONGYI_ACCESS_KEY_ID"
          # è¿™é‡Œåœ¨å®é™…ç¯å¢ƒä¸­éœ€è¦ä½¿ç”¨ CloudBase CLI è®¾ç½®ç¯å¢ƒå˜é‡
        fi
        
        if [ ! -z "$ALIBABA_ACCESS_KEY_ID" ]; then
          echo "è®¾ç½® ALIBABA_ACCESS_KEY_ID"
        fi
        
        echo "âœ… ç¯å¢ƒå˜é‡è®¾ç½®å®Œæˆ"
        
    - name: éƒ¨ç½²åˆ° CloudBase
      run: |
        echo "å¼€å§‹éƒ¨ç½²åˆ° CloudBase..."
        npm run deploy
        
    - name: éƒ¨ç½²åå¥åº·æ£€æŸ¥
      run: |
        echo "æ‰§è¡Œéƒ¨ç½²åå¥åº·æ£€æŸ¥..."
        # ç­‰å¾…éƒ¨ç½²å®Œæˆ
        sleep 30
        
        # æ£€æŸ¥å¥åº·æ£€æŸ¥ç«¯ç‚¹
        HEALTH_URL="https://suiyue-memoir-dev-3e9aoud20837ef.tcloudbaseapp.com/health"
        echo "æ£€æŸ¥å¥åº·æ£€æŸ¥ç«¯ç‚¹: $HEALTH_URL"
        
        # ç®€å•çš„HTTPæ£€æŸ¥
        if curl -f -s "$HEALTH_URL" > /dev/null; then
          echo "âœ… åº”ç”¨éƒ¨ç½²æˆåŠŸï¼Œå¥åº·æ£€æŸ¥é€šè¿‡"
        else
          echo "âš ï¸  å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œä½†éƒ¨ç½²å¯èƒ½ä»ç„¶æˆåŠŸ"
        fi

  # é€šçŸ¥
  notify:
    runs-on: ubuntu-latest
    name: éƒ¨ç½²é€šçŸ¥
    needs: [deploy]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
    - name: éƒ¨ç½²ç»“æœé€šçŸ¥
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "ğŸ‰ å²é˜…é¡¹ç›®éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ è®¿é—®åœ°å€: https://suiyue-memoir-dev-3e9aoud20837ef.tcloudbaseapp.com"
        else
          echo "âŒ å²é˜…é¡¹ç›®éƒ¨ç½²å¤±è´¥"
        fi